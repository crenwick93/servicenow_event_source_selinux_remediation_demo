---
- name: Create ServiceNow emergency change request
  hosts: localhost
  become: false
  gather_facts: false
  vars:
    # ServiceNow connection is taken from environment variables set by env_script.sh
    # Required env vars: SN_HOST, SN_USERNAME, SN_PASSWORD

    # change_short_description: "Emergency change - TEST15"
    # change_description: "Detected critical hardware failure on primary DB server; immediate replacement required."
    # change_impact: high
    # change_urgency: high
    # change_assignment_group: "Event Driven Ansible"
    # change_assigned_to: ""
    # change_start: ""
    # change_end: ""

    # # Incident fields
    # incident_short_description: "Prod alert - pre-change incident"
    # incident_description: "Opening incident associated with the automated emergency change."
    # incident_impact: high
    # incident_urgency: high
    # incident_assignment_group: "{{ change_assignment_group }}"

    # Alertmanager fingerprint to correlate incident and change
    alert_fingerprint: ""

    # Implementation execution defaults (can be overridden by caller)
    # implementation_job_template_name: "se_linux_remediation"
    implementation_job_template_name: "{{ implementation_job_template_name }}"
    implementation_job_template_org: "Demo3"

  tasks:
    - name: Create emergency change request
      servicenow.itsm.change_request:
        state: new
        type: emergency
        short_description: "{{ change_short_description }}"
        description: "{{ change_description }}"
        impact: "{{ change_impact }}"
        urgency: "{{ change_urgency }}"
        assignment_group: "{{ change_assignment_group | default(omit) }}"
        other: "{{ {
            'parent': (incident_sys_id | default(omit)),
            'correlation_id': (alert_fingerprint | default(omit)),
            'correlation_display': (incident_number | default(omit))
          } }}"
      register: change

    - name: Build implementation plan payload for downstream automation
      ansible.builtin.set_fact:
        implementation_payload:
          job_template: "{{ implementation_job_template_name }}"
          organization: "{{ implementation_job_template_org }}"
          extra_vars:
            target_host: "{{ target_host | default('') }}"
            incident_sys_id: "{{ incident_sys_id | default('') }}"

    - name: Update change with implementation plan JSON
      servicenow.itsm.change_request:
        number: "{{ change.record.number }}"
        other: "{{ {'implementation_plan': (implementation_payload | to_json)} }}"

    - name: Move change to Authorize and request approval
      servicenow.itsm.change_request:
        number: "{{ change.record.number }}"
        state: authorize
        assignment_group: "{{ change_assignment_group }}"
        other: "{{ {'approval': 'requested'} }}"

    - name: Show change identifiers
      ansible.builtin.debug:
        msg:
          - "Change number: {{ change.record.number | default('unknown') }}"
          - "Change sys_id: {{ change.record.sys_id | default('unknown') }}"

    - name: Emit identifiers for downstream workflow nodes
      ansible.builtin.set_stats:
        data:
          change_number: "{{ change.record.number | default('') }}"
        aggregate: false
